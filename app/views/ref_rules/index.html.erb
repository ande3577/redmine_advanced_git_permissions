<div class="contextual">
<%= link_to l(:label_ref_rule_new), {:controller => 'ref_rules', :action => 'new', :repository_id => @repository}, :class => 'icon icon-add' %>
</div>

<% if @repository.nil? %>
  <h3><%= l :label_git_global_ref_rule %></h3>
<% else %>
  <h3><%= l :label_git_global_ref_rule_for, :repository => @repository.identifier %></h3>
  
  <% if User.current().allowed_to? :manage_ref_rules, @repository.project %>
    <%= form_tag({:controller => :ref_rules, :action => :update_repository_settings}, :method => :put) do %>
      <%= label_tag l(:field_inherit_global_rules) %>
      <%= check_box_tag :inherit_global_rules, true, @repository.inherit_global_rules  %>
      <p>
        <%= content_tag(:label, l(:label_default_branch_rule)) %>
        <%= select_tag :default_branch_rule, options_for_select([[l(:label_inherit_global_default, :rule_type => Setting.plugin_redmine_advanced_git_permissions[:default_branch_rule]),:inherit_global],[l(:label_public_ref),:public_ref],[l(:label_protected_ref), :protected_ref],[l(:label_illegal_ref), :illegal_ref]], @repository.default_branch_rule) %>
      </p>
      <p>
        <%= content_tag(:label, l(:label_default_tag_rule)) %>
        <%= select_tag :default_tag_rule, options_for_select([[l(:label_inherit_global_default, :rule_type => Setting.plugin_redmine_advanced_git_permissions[:default_tag_rule]),:inherit_global],[l(:label_public_ref),:public_ref],[l(:label_protected_ref), :protected_ref],[l(:label_illegal_ref), :illegal_ref]], @repository.default_tag_rule) %>
      </p>
      <p>
        <%= submit_tag l :button_submit  %>
      </p>
    <% end %>
  <% else %>
    <p><strong>
    <%= l(:label_default_branch_rule) + ": "%>
    <% if @repository.default_branch_rule.nil? %>
      <%= Setting.plugin_redmine_advanced_git_permissions[:default_branch_rule] %>     
    <% else %>
      <%= @repository.default_branch_rule %>
    <% end %>
    </strong></p>
    <p><strong>
    <%= l(:label_default_tag_rule) %>
    <% if @repository.default_tag_rule.nil? %>
      <%= Setting.plugin_redmine_advanced_git_permissions[:default_tag_rule] %>     
    <% else %>
      <%= @repository.default_tag_rule %>
    <% end %>
    </strong></p>
  <% end %>
  
<% end %>

<% if @ref_rules.empty? %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
  <table class="list">
    <thead><tr>
    <th><%=l(:field_ref_type)%></th>
    <th><%=l(:field_rule_type)%></th>
    <th><%=l(:field_expression)%></th>
    <th><%=l(:field_regex)%></th>
    <th></th>
    <th></th>
    </tr></thead>
    <tbody>
  <% @ref_rules.each do |rule| %>
    <tr class="<%= cycle 'odd', 'even' %>">
      <td align="center"><%= rule.ref_type %></td>
      <td align="center"><%= rule.rule_type %></td>
      <td align="center"><%= rule.expression %></td>
      <td align="center"><%= rule.regex %></td>
      <% if (!@repository.nil? && rule.global) or !User.current().allowed_to?(:manage_ref_rules, @repository.project) %>
        <td></td>
        <td></td>
      <% else %>
        <td class="buttons"><%= link_to l(:button_edit), { :controller => 'ref_rules', :action => 'edit', :id => rule }, {:class => 'icon icon-edit'} %></td>
        <td class="buttons"><%= delete_link rule %></td>
      <% end %>
    </tr>
  <% end %>
  </table>
<% end %>

